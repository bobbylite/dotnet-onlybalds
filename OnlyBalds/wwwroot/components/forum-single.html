<style>
.thread-header {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
    margin-bottom: 1rem;
}

.thread-actions {
    align-self: flex-end;
}

/* Cool Favorites Action Styles */
.favorites-btn {
    position: relative;
    width: 28px;
    height: 28px;
    border-radius: 50%;
    background-color: black;
    color: white;
    border: none;
    font-size: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    padding: 0;
    transition: background-color 0.2s ease;
}

.favorites-btn:hover {
    background-color: #333;
}

.favorites-btn:active {
    transform: scale(0.95);
}

/* Favorite State (when favorited) */
.favorites-btn.favorited {
    background-color: #ff4757;
    color: #fff;
}

.favorites-btn.favorited:hover {
    background-color: #ff3742;
}

/* Favorite count badge */
.favorites-count {
    position: absolute;
    top: -8px;
    right: -8px;
    background: #000;
    color: white;
    border-radius: 50%;
    width: 18px;
    height: 18px;
    font-size: 10px;
    font-weight: bold;
    display: flex;
    align-items: center;
    justify-content: center;
    border: 2px solid white;
    transform: scale(0);
    transition: all 0.3s ease;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
}

.favorites-count.show {
    transform: scale(1);
}

</style>
<!-- FORUM LISTINGS
============================================== -->
<div id="spinner-holder" class="box__holder">
    <div class="flex-center">
        <div class="spinner-border" role="status" aria-label="Loading"></div>
    </div>
</div>

<div id="app-holder" class="section section--gray article" style="display: none;">
    <div class="container article__container">

        <div class="article__content thread-header" data-aos="fade-up" data-aos-delay="150" data-aos-offset="0">
            <h1 id="article-title" class="h2 article__heading"></h1>
            <div class="article__actions thread-actions">
                <button class="favorites-btn" id="star-post" title="Add to Favorites">
                    <i class="fa fa-heart"></i>
                    <span class="favorites-count" id="favorites-count">0</span>
                </button>
                <button class="circle-btn" id="edit-post" title="Edit Post">
                    <i class="fa fa-pencil"></i>
                </button>
                <button class="circle-btn" id="delete-post" title="Delete Post">
                    <i class="fa fa-trash"></i>
                </button>
            </div>
            <div class="author-info">
                <div class="listing__meta-author">
                    <svg xmlns="http://www.w3.org/2000/svg" style="margin-left: 10px; margin-top: 5px;" width="50" height="50" fill="currentColor"
                        class="bi bi-person-fill" viewBox="0 0 16 16">
                        <path
                            d="M3 14s-1 0-1-1 1-4 6-4 6 3 6 4-1 1-1 1zm5-6a3 3 0 1 0 0-6 3 3 0 0 0 0 6" />
                    </svg>
                </div>
                <div class="author-info__content">
                    <p id="article-author" class="author-info__name"></p>
                    <p id="article-date" class="author-info__date"></p>
                </div>
            </div>
            <div id="article-content" class="article__body" data-aos="fade-up" data-aos-delay="150" data-aos-offset="0">
            </div>
        </div>

        <div class="article__comments" data-aos="fade-up" data-aos-delay="150" data-aos-offset="0">
            <h2 id="comments-count" class="h4 article__comment-count"></h2>

            <ul id="comments-list" class="list-group list-group-flush list-unstyled">

            </ul>
        </div>
    
        <form class="article__write-comment" data-aos="fade-up" data-aos-delay="150" data-aos-offset="0">
            <h2 class="h4 article__write-comment-heading">Leave A Comment</h2>
            <textarea name="" id="" placeholder="Enter your message here..." class="article__comment-textarea"></textarea>
            <button id="comment-button" class="btn btn--blue article__post-comment-btn">Post Comment</button>
        </form>

    </div>
</div><!--forum listings -->

<script>
    var userId = '';
    var isEditing = false;
    var originalTitle = '';
    var originalContent = '';

    $.ajax({
        url: "/identity-information",
        method: "GET",
        success: function (data) {
            window.loggedInUserId = data.claims.sub;
        }
    });

    $(document).ready(() => {
        const params = new URLSearchParams(window.location.search);
        const postId = params.get("postId");

        $.ajax({
            url: `/onlybalds-api/posts?postId=${postId}`,
            method: "GET",
            dataType: "json",
            success: function (data) {
                let post = data;
                $("#article-title").text(post.title);
                $("#article-author").text(`Posted by ${post.author}`);
                $("#article-content").html(post.content);
                userId = post.userId;
                PopulateComments(postId, post);

                $('#app-holder').css('display', 'block');
                $('#spinner-holder').remove();
            },
            error: function (xhr, status, error) {
                console.error("Error fetching thread:", error);
            }
        });
    });

    function PopulateComments(postId, userData) {
        $.ajax({
            url: `/onlybalds-api/comments?postId=${postId}`,
            method: "GET",
            dataType: "json",
            success: function (data) {
                var filteredComments = data.filter(comment => comment.postId === postId);
                console.log("Filtered comments:", filteredComments);
                console.log("Calling PopulateComments()");

                
                $('#comments-count').empty();
                $('#comments-count').text(`${filteredComments.length} Comment${filteredComments.length !== 1 ? 's' : ''}`);
                
                $("#comments-list").empty();
                filteredComments.forEach(comment => {
                    console.log("Comment:", comment);
                    let newCommentHtml = 
                        `
                        <div class="comment">
                            <div class="comment__author-info author-info">
                                <div class="listing__meta-author">
                                    <svg xmlns="http://www.w3.org/2000/svg" style="margin-left: 10px; margin-top: 5px;" width="50" height="50" fill="currentColor"
                                        class="bi bi-person-fill" viewBox="0 0 16 16">
                                        <path
                                            d="M3 14s-1 0-1-1 1-4 6-4 6 3 6 4-1 1-1 1zm5-6a3 3 0 1 0 0-6 3 3 0 0 0 0 6" />
                                    </svg>
                                </div>

                                <div class="comment__delete-btn">
                                    <button class="circle-btn delete-comment-btn" title="Delete Comment" data-id="${comment.id}">
                                        <i class="fa fa-trash"></i>
                                    </button>
                                </div>

                                <div class="author-info__content">
                                    <p id="post-author" class="author-info__name">Posted by ${comment.author}</p>
                                    <p class="author-info__date">${new Date(comment.postedOn).toLocaleDateString()}</p>
                                </div>
                            </div>

                            <div class="comment__text">
                                <p>${comment.content}</p>
                            </div>
                        </div>
                        `;

                    let $newComment = $(newCommentHtml).hide();
                    $("#comments-list").append($newComment);
                    $newComment.fadeIn(700);
                });
            },
            error: function (xhr, status, error) {
                console.error("Error fetching comments:", error);
            }
        });
    };

    $(document).ready(function () {
        $('#comment-button').on('click', function (e) {
            e.preventDefault();

            var $btn = $(this);
            $btn.html(`<span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span> Sending...`);
            $btn.prop('disabled', true);

            $.ajax({
                url: "/identity-information",
                method: "GET",
                success: function (data) {
                    var userId = data.claims.sub;
                    var params = new URLSearchParams(window.location.search);
                    var postId = params.get('postId');

                    var commentItem = {
                        id: crypto.randomUUID(),
                        author: data.name,
                        content: $(".article__comment-textarea").val(),
                        postedOn: new Date().toISOString(),
                        postId: postId,
                        userId: userId
                    };

                    $.ajax({
                        url: '/onlybalds-api/comments',
                        type: 'POST',
                        contentType: 'application/json',
                        data: JSON.stringify(commentItem),
                        success: function (response) {
                            console.log('Post successful:', response);

                            $btn.html("Send Message");
                            $btn.prop('disabled', false);

                            var newCommentHtml = `
                                <div class="comment">
                                    <div class="comment__author-info author-info">
                                        <div class="listing__meta-author">
                                            <svg xmlns="http://www.w3.org/2000/svg" style="margin-left: 10px; margin-top: 5px;" width="50" height="50" fill="currentColor"
                                                class="bi bi-person-fill" viewBox="0 0 16 16">
                                                <path d="M3 14s-1 0-1-1 1-4 6-4 6 3 6 4-1 1-1 1zm5-6a3 3 0 1 0 0-6 3 3 0 0 0 0 6" />
                                            </svg>
                                        </div>

                                        <div class="comment__delete-btn">
                                            <button class="circle-btn delete-comment-btn" title="Delete Comment" data-id="${commentItem.id}">
                                                <i class="fa fa-trash"></i>
                                            </button>
                                        </div>

                                        <div class="author-info__content">
                                            <p id="post-author" class="author-info__name">Posted by ${commentItem.author}</p>
                                            <p class="author-info__date">${new Date(commentItem.postedOn).toLocaleDateString()}</p>
                                        </div>
                                    </div>

                                    <div class="comment__text">
                                        <p>${commentItem.content}</p>
                                    </div>
                                </div>
                            `;

                            var $newComment = $(newCommentHtml).hide();
                            $("#comments-list").append($newComment);
                            $newComment.fadeIn(300);

                            var $commentsCount = $("#comments-count");

                            var currentCommentsCount = Number($commentsCount.text().replace(/\D/g, '')); // Strip non-digits

                            var updatedCommentsCount = currentCommentsCount + 1;

                            $commentsCount.text(`${updatedCommentsCount} comment${updatedCommentsCount !== 1 ? 's' : ''}`);

                            $(".article__comment-textarea").val('');
                        },
                        error: function (xhr, status, error) {
                            console.error('Post failed:', error);
                        }
                    });

                },
                error: function (xhr, status, error) {
                    console.error("User data error:", error);
                }
            });
        });

    });

    $('#delete-post').on('click', function (e) {
        e.preventDefault();
        var params = new URLSearchParams(window.location.search);
        var postId = params.get('postId');

        $.ajax({
            url: `/onlybalds-api/posts?postId=${postId}`,
            type: 'DELETE',
            success: function(response) {
                console.log('Post deleted successfully:', response);
                window.app.scripts.loadForum();
            },
            error: function(xhr, status, error) {
                if (xhr.status === 401) {
                    window.app.scripts.showToast("You can only delete your own post");
                } else {
                    window.app.scripts.showToast("An unexpected error occurred.");
                }
            }
        });
    });

    $(document).off('click', '.delete-comment-btn').on('click', '.delete-comment-btn', function (e) {
        e.preventDefault();

        const $btn = $(this);
        const commentId = $btn.data('id');
        const $commentElement = $btn.closest('.comment');

        console.log("Deleting comment with ID:", commentId);

        $btn.prop('disabled', true);

        $.ajax({
            url: `/onlybalds-api/comments?commentId=${commentId}`,
            type: 'DELETE',
            success: function (response) {
                console.log('Comment deleted:', response);

                $commentElement.fadeOut(300, function () {
                    $(this).remove();

                    const $count = $("#comments-count");
                    const current = parseInt($count.text().replace(/\D/g, ''), 10);
                    const updated = Math.max(current - 1, 0);
                    $count.text(`${updated} comment${updated !== 1 ? 's' : ''}`);
                });
            },
            error: function (xhr, status, error) {
                $btn.prop('disabled', false);
                
                if (xhr.status === 401) {
                    window.app.scripts.showToast("You can only delete your own comment");
                } else {
                    window.app.scripts.showToast("An unexpected error occurred.");
                }
            }
        });
    });

    $('#edit-post').on('click', function () {
        console.log("Edit post clicked");
        if (isEditing) return;

        const currentUserId = window.loggedInUserId;
        const postOwnerId = userId;

        if (currentUserId !== postOwnerId) {
            window.app.scripts.showToast("You can only edit your own post");
            return;
        }

        isEditing = true;

        const $titleEl = $('#article-title');
        const $contentEl = $('#article-content');

        originalTitle = $titleEl.text();
        originalContent = $contentEl.html();

        $titleEl.replaceWith(`
            <input 
                type="text" 
                id="edit-title" 
                class="article__heading input-title" 
                style="width: 100%; font-size: 2rem; font-weight: bold; margin-bottom: 1rem; margin-top: 100px;" 
                value="${originalTitle}"
            >
        `);

        $contentEl.replaceWith(`
            <textarea 
                id="edit-content" 
                class="article__body input-content" 
                style="width: 100%; height: 300px; font-size: 1.1rem; padding: 1rem; resize: vertical;"
            >${originalContent.replace(/<\/?[^>]+(>|$)/g, "")}</textarea>
        `);

        $('.article__actions').append(`
            <button class="circle-btn" id="save-post" title="Save Post">
                <i class="fa fa-check"></i>
            </button>
            <button class="circle-btn" id="cancel-edit" title="Cancel Edit">
                <i class="fa fa-times"></i>
            </button>
        `);
    });

    $(document).on('click', '#save-post', function () {
        const updatedTitle = $('#edit-title').val().trim();
        const updatedContent = $('#edit-content').val().trim();
        const params = new URLSearchParams(window.location.search);
        const postId = params.get('postId');

        if (!updatedTitle || !updatedContent) {
            window.app.scripts.showToast("Title and content cannot be empty");
            return;
        }

        $.ajax({
            url: `/onlybalds-api/posts?postId=${postId}`,
            method: 'PATCH',
            contentType: 'application/json',
            data: JSON.stringify({
                postId,
                title: updatedTitle,
                content: updatedContent
            }),
            success: function (res) {
                $('#edit-title').replaceWith(`<h1 id="article-title" class="h2 article__heading">${updatedTitle}</h1>`);
                $('#edit-content').replaceWith(`<div id="article-content" class="article__body">${updatedContent}</div>`);
                $('#save-post, #cancel-edit').remove();
                isEditing = false;

                window.app.scripts.showToast("Post updated successfully");
            },
            error: function (xhr) {
                if (xhr.status === 401) {
                    window.app.scripts.showToast("You can only edit your own post");
                } else {
                    window.app.scripts.showToast("Failed to update post");
                }
            }
        });
    });

    $(document).on('click', '#cancel-edit', function () {
        $('#edit-title').replaceWith(`<h1 id="article-title" class="h2 article__heading">${originalTitle}</h1>`);
        $('#edit-content').replaceWith(`<div id="article-content" class="article__body">${originalContent}</div>`);
        $('#save-post, #cancel-edit').remove();
        isEditing = false;
    });

    var isFavorited = false;
    var favoritesCount = 0;
    var favoriteId = null;

    $(document).ready(function() {
        const params = new URLSearchParams(window.location.search);
        const postId = params.get("postId");
        
        loadFavoritesState(postId);
    });

    function loadFavoritesState(postId) {
        $.ajax({
            url: `/onlybalds-api/favorites?postId=${postId}`,
            method: "GET",
            success: function(data) {
                console.log("Favorites state:", data);
                data.forEach(favorite => {
                    console.log("Favorite:", favorite);
                    console.log("User ID:", user.claims.sub);
                    if (favorite.userId === user.claims.sub) {
                        console.log("User has favorited this post");
                        isFavorited = true;
                        favoriteId = favorite.id;
                    }
                });
                favoritesCount = data.length;
                updateFavoritesUI();
            },
            error: function(xhr, status, error) {
                console.error("Error loading favorites state:", error);
                isFavorited = false;
                favoritesCount = 0;
                updateFavoritesUI();
            }
        });
    }

    function updateFavoritesUI() {
        const $btn = $('#star-post');
        const $count = $('#favorites-count');
        
        if (isFavorited) {
            $btn.addClass('favorited');
            $btn.attr('title', 'Remove from Favorites');
        } else {
            $btn.removeClass('favorited');
            $btn.attr('title', 'Add to Favorites');
        }
        
        $count.text(favoritesCount);
        if (favoritesCount > 0) {
            $count.addClass('show');
        } else {
            $count.removeClass('show');
        }
    }

    $('#star-post').on('click', function(e) {
        e.preventDefault();
        
        const $btn = $(this);
        const params = new URLSearchParams(window.location.search);
        const postId = params.get("postId");
        
        // Prevent double-clicking
        if ($btn.hasClass('processing')) return;
        $btn.addClass('processing');
        
        updateFavoritesUI();
        
        if (isFavorited)
        {
            $.ajax({
                url: `/onlybalds-api/favorites?favoriteId=${favoriteId}`,
                method: 'DELETE',
                contentType: 'application/json',
                success: function(response) {
                    isFavorited = false
                    favoritesCount = favoritesCount - 1;
                    updateFavoritesUI();
                    $btn.removeClass('processing');
                },
                error: function(xhr, status, error) {
                    $btn.removeClass('processing');
                    window.app.scripts.showToast("Failed to update favorites");
                }
            });
        }

        if (!isFavorited)
        {
            $.ajax({
                url: '/onlybalds-api/favorites',
                method: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({
                    postId: postId,
                    userId: user.claims.sub
                }),
                success: function(response) {
                    isFavorited = true;
                    favoriteId = response.id;
                    favoritesCount = favoritesCount + 1;
                    updateFavoritesUI();
                    $btn.removeClass('processing');
                },
                error: function(xhr, status, error) {
                    $btn.removeClass('processing');
                    window.app.scripts.showToast("Failed to update favorites");
                }
            });
        }
    });
</script>
