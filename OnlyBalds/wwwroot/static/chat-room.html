<!DOCTYPE html>
<html>
<head>
	<meta name="viewport" content="width=device-width, initial-scale=1" />

	<title>Chat Room | Only Balds</title>
	<meta name="description" content="">

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Libre+Franklin:ital,wght@0,100..900;1,100..900&display=swap" rel="stylesheet">

	<link href="https://stackpath.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet">

	<!--[if lt IE 9]>
	<script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
	<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
	<![endif]-->   
	
	<link rel="icon" href="images/favicon-16.png" sizes="16x16" type="image/png">
	<link rel="icon" href="images/favicon-32.png" sizes="32x32" type="image/png">
	<link rel="icon" href="images/favicon-48.png" sizes="48x48" type="image/png">
	<link rel="icon" href="images/favicon-62.png" sizes="62x62" type="image/png">
	<link rel="apple-touch-icon" href="apple-touch-icon.png">
	<meta property="og:url" content="https://example.com/page.html">
	<meta property="og:type" content="website">
	<meta property="og:title" content="Content Title">
	<meta property="og:image" content="https://example.com/image.jpg">
	<meta property="og:description" content="Description Here">
	<meta property="og:site_name" content="Site Name">
	<meta property="og:locale" content="en_US">

    <link rel="stylesheet" href="/app.css"/>

	<link rel="stylesheet" href="assets/styles/styles-1d9c2d7206.css"/>

	<script src="assets/scripts/Vendor-07ad14d4d0.js"></script>

</head>
<body>

	<!-- COMMENT
	================================================== -->
	<div class="navbar">
		<div class="navbar__left">
			<a href="/" class="navbar__logo">
                <img src="/assets/images/logo.png" alt="Only Balds" >
            </a>
		</div>
		<nav class="navbar__nav">
			<ul class="nav main-nav">
				<li class="nav__item"><a href="/about" class="nav__link">About</a></li>
				<li class="nav__item"><a href="/forum" class="nav__link">Forum</a></li>
				<li class="nav__item"><a href="/chat-room" class="nav__link">Chat Room</a></li>
				<li class="nav__item"><a href="/marketplace" class="nav__link">Marketplace</a></li>
				<li class="nav__item dropdown">
					<a href="#" class="nav__link dropdown__toggle" role="button">Social
						<i class="fa fa-angle-down dropdown__toggle-icon"></i>
					</a>
					<ul class="dropdown__nav">
						<li class="dropdown__item"><a href="#" class="dropdown__link dropdown__link--icon" target="_blank"><i class="fa fa-facebook-square"></i> Facebook</a></li>
						<li class="dropdown__item"><a href="https://www.instagram.com/onlybaldsllc/" class="dropdown__link dropdown__link--icon" target="_blank"><i class="fa fa-instagram"></i> Instagram</a></li>
					</ul>
				</li>
			</ul>
		</nav>
		<div class="navbar__right dropdown">
			<a href="#" class="navbar__user-dropdown">
                <div class="navbar__user-profile-abbrev">
                    <div class="navbar__user-profile-abbrev-text">
                        <svg xmlns="http://www.w3.org/2000/svg" style="margin-top: 5px;" width="16" height="16" fill="currentColor" class="bi bi-person-circle" viewBox="0 0 16 16">
                            <path d="M11 6a3 3 0 1 1-6 0 3 3 0 0 1 6 0"/>
                            <path fill-rule="evenodd" d="M0 8a8 8 0 1 1 16 0A8 8 0 0 1 0 8m8-7a7 7 0 0 0-5.468 11.37C3.242 11.226 4.805 10 8 10s4.757 1.225 5.468 2.37A7 7 0 0 0 8 1"/>
                        </svg>
                    </div>
                </div> 
                <span class="navbar__mobile-hide">My </span>Account <i class="fa fa-angle-down dropdown__toggle-icon"></i>
            </a>
            <ul id="menu-options" class="dropdown__nav dropdown__nav--user">
                <li class="dropdown__item dropdown__item--title greeting"></li>
                <li class="dropdown__item">
                    <a href="/account-questionnaire" class="dropdown__link dropdown__link--icon">
                        <i class="fa fa-edit"></i> 
                        Questionnaire
                    </a>
                </li>
                <li class="dropdown__item sign-in">
                    <a href="/auth/login" class="dropdown__link dropdown__link--icon">
                        <i class="fa fa-sign-in"></i> 
                        Sign In
                    </a>
                </li>
            </ul>
            <div class="navbar__mobile-buttons">
                <button class="navbar__toggle navicon">
                    <div class="navicon__holder">
                        <div class="navicon__line"></div>
                        <div class="navicon__line"></div>
                        <div class="navicon__line"></div>
                    </div>
                </button>
            </div> 
		</div>
	</div><!--/comment -->
	
    <!-- BANNER
    ============================================== -->
    <div class="banner banner--fade-to-gray">
        <div class="container">
            <h1 class="banner__heading"  data-aos="fade-up" data-aos-delay="100" data-aos-offset="0">Chat With The Community</h1>
            <p class="lead banner__paragraph" data-aos="fade-up" data-aos-delay="200" data-aos-offset="0">Join our members-only chat and see what our community is talking about.</p>
        </div>
    </div><!--/banner -->

    <!-- MARKETPLACE
    ============================================== -->
    <div class="section section--gray">
        <div class="container">
            <div class="box box--with-top-lines"  data-aos="fade-up" data-aos-delay="150" data-aos-offset="0">
                <div class="box__top-line box__top-line--light-blue"></div>
                <div class="box__top-line box__top-line--blue"></div>


                <div id="spinner-holder" class="box__holder">
                    <div class="flex-center">
                        <div class="spinner-border" role="status" aria-label="Loading"></div>
                    </div>
                </div>

                <div id="app-holder" class="box__holder" style="display:none;">
                    <ul class="box__header">
                        <li class="box__header-item box__header-item--title">
                            <div id="userCount"></div> 
                        </li>
                        <li class="box__header-item">
                            <a href="#chat-users-online" class="box-header__button ui-button chat-users-online-trigger">See Who's Online</a>
                        </li>
                    </ul>
                    <div class="box__section box__section--chat-frame">

                        <!--<button class="chat-scroll-btn">New Messages!</button>-->
                        <ul id="chatMessages" class="list-group list-group-flush list-unstyled">

                        </ul>
                    </div>
                    <div class="box__section box__section--form-box box__section--top-border" data-aos="fade-up" data-aos-delay="150" data-aos-offset="0">
                        <textarea id="messageInput" name="" placeholder="Enter your message here..."></textarea>
                        <button id="sendButton" class="btn btn--blue">Send Message</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div style="display:none">
        <div class="popup" id="chat-users-online">
            <div class="popup__header">
                <h2 class="popup__heading">Chat Room Users Online</h2>
                <button class="popup__close">&times;</button>
            </div>
            <div class="popup__content">
                <ul id="activeUsers" class="user-list">
                </ul>
            </div>
        </div>
    </div>

	    <div class="footer">
        <div class="container">
            <div class="footer__buttons">
                <ul class="footer__button-links">
                    <li><a href="/forum" class="btn btn--rounded btn--faded">Forum</a></li>
                    <li><a href="/chat-room" class="btn btn--rounded btn--faded">Chat Room</a></li>
                    <li><a href="/marketplace" class="btn btn--rounded btn--faded">Marketplace</a></li>
                    <li class="footer__right-list-item"><a href="/account-questionnaire" class="btn btn--rounded btn--white">Become A Member</a></li>
                </ul>
            </div>
        </div>
        <img src="/assets/images/only-balds-face-icon.png" alt="" aria-hidden="true" class="footer__face-icon">
    </div>

    <script src="assets/scripts/App-5379555225.js"></script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/microsoft-signalr/7.0.5/signalr.min.js"></script>

    <script>
        $(() => {
            $.ajax({
                url: "/identity-information",
                method: "GET",
                success: function (data) {
                    user = data;
                    let userName = user.name;
                    console.log("User name:", userName);
                    $(".sign-in").remove();
                    $(".greeting").empty().append(`Hi, ${userName}`);
                    $("#menu-options").append(`
                        <li class="dropdown__item sign-out">
                            <a href="/auth/logout" class="dropdown__link dropdown__link--icon">
                                <i class="fa fa-sign-out"></i> 
                                Sign Out
                            </a>
                        </li>
                    `);
                },
                error: function (xhr, status, error) {
                }
            });
        });
    </script>

    <script>
        let hubConnection;
        let messages = [];
        let user = null;
        let activeUsers = [];

        function connectToChatHub(user) {
            hubConnection = new signalR.HubConnectionBuilder()
                .withUrl(`/chathub?username=${encodeURIComponent(user)}`)
                .build();

            hubConnection.on("ReceiveMessage", function (username, message) {
                const chatMessage = {
                    user: username,
                    content: message,
                    timestamp: new Date()
                };

                messages.push(chatMessage);
                onStateChanged();
            });

            hubConnection.on("UserCountChanged", function (count, users) {
                console.log("Connected users:", count);
                console.log("Users JSON:", users);
                activeUsers = JSON.parse(users);
                console.log("Active Users:", activeUsers);
                $("#userCount").text(`${count} Members Are Here!`);
                const $chatList = $("#activeUsers");
                $chatList.empty();
                activeUsers.forEach(activeUser => {
                    $chatList.append(`
                        <li class="user-list__item">
                            <div class="chat-item__profile-picture me-3 d-flex justify-content-center align-items-center text-center" style="width: 40px; height: 40px;">
                                <svg xmlns="http://www.w3.org/2000/svg" style="margin-left: 10px; margin-top: 5px;" width="30" height="30" fill="currentColor"
                                    class="bi bi-person-fill" viewBox="0 0 16 16">
                                    <path
                                        d="M3 14s-1 0-1-1 1-4 6-4 6 3 6 4-1 1-1 1zm5-6a3 3 0 1 0 0-6 3 3 0 0 0 0 6" />
                                </svg>
                            </div>                            
                            <span class="user-list__name">${activeUser}</span>
                        </li>
                    `);
                });
            });

            hubConnection.start().then(function () {
                if (typeof onChatHubConnected === "function") {
                    onChatHubConnected();
                }
            }).catch(function (err) {
                console.error("SignalR connection error:", err.toString());
            });
        }

        function onStateChanged() {
            const $btn = $("#sendButton");
            $btn.html("Send Message");
            $btn.prop('disabled', false);
            const $chatList = $("#chatMessages");
            $chatList.empty();
            messages.forEach(msg => {
                var currentUsername = user.name;
                var messageTemplate = '';
                if (msg.user === currentUsername)
                {
                    messageTemplate = `
                    <li class="list-group-item d-flex justify-content-center">
                        <div class="chat-item chat-item--message chat-item--is-you d-flex align-items-center" style="max-width: 600px; width: 100%;">
                            <div class="chat-item__profile-picture me-3 d-flex justify-content-center align-items-center text-center" style="width: 40px; height: 40px;">
                                <svg xmlns="http://www.w3.org/2000/svg" style="margin-left: 10px; margin-top: 5px;" width="30" height="30" fill="currentColor"
                                    class="bi bi-person-fill" viewBox="0 0 16 16">
                                    <path
                                        d="M3 14s-1 0-1-1 1-4 6-4 6 3 6 4-1 1-1 1zm5-6a3 3 0 1 0 0-6 3 3 0 0 0 0 6" />
                                </svg>
                            </div>
                            <div class="chat-item__text">
                                <span class="chat-item__author"><b>${msg.user}</b></span>
                                <div class="chat-item__message">
                                    ${msg.content}
                                </div>
                            </div>
                        </div>
                    </li>
                    `;
                }
                else if (msg.user === "Moderator" && msg.content.includes("has joined."))
                {
                    messageTemplate = `
                    <li class="list-group-item d-flex justify-content-center">
                        <div class="chat-item chat-item--joined d-flex align-items-center" style="max-width: 600px; width: 100%;">
                            <div class="chat-item__profile-picture me-3 d-flex justify-content-center align-items-center text-center" style="width: 40px; height: 40px;">
                                <svg xmlns="http://www.w3.org/2000/svg" style="margin-left: 10px; margin-top: 5px;" width="30" height="30" fill="currentColor"
                                    class="bi bi-person-fill" viewBox="0 0 16 16">
                                    <path
                                        d="M3 14s-1 0-1-1 1-4 6-4 6 3 6 4-1 1-1 1zm5-6a3 3 0 1 0 0-6 3 3 0 0 0 0 6" />
                                </svg>
                            </div>
                            <div class="chat-item__text">
                                <span class="chat-item__author"><b>${msg.user}</b></span>
                                <div class="chat-item__message">
                                    ${msg.content}
                                </div>
                            </div>
                        </div>
                    </li>
                    `;
                }
                else if (msg.user === "Moderator" && msg.content.includes("has left."))
                {
                    messageTemplate = `
                    <li class="list-group-item d-flex justify-content-center">
                        <div class="chat-item chat-item--joined d-flex align-items-center" style="max-width: 600px; width: 100%;">
                            <div class="chat-item__profile-picture me-3 d-flex justify-content-center align-items-center text-center" style="width: 40px; height: 40px;">
                                <svg xmlns="http://www.w3.org/2000/svg" style="margin-left: 10px; margin-top: 5px;" width="30" height="30" fill="currentColor"
                                    class="bi bi-person-fill" viewBox="0 0 16 16">
                                    <path
                                        d="M3 14s-1 0-1-1 1-4 6-4 6 3 6 4-1 1-1 1zm5-6a3 3 0 1 0 0-6 3 3 0 0 0 0 6" />
                                </svg>
                            </div>
                            <div class="chat-item__text">
                                <span class="chat-item__author"><b>${msg.user}</b></span>
                                <div class="chat-item__message">
                                    ${msg.content}
                                </div>
                            </div>
                        </div>
                    </li>
                    `;
                }
                else if (msg.user === "Moderator" && msg.content.includes("blocked"))
                {
                    messageTemplate = `
                    <li class="list-group-item d-flex justify-content-center">
                        <div class="chat-item chat-item--left d-flex align-items-center" style="max-width: 600px; width: 100%;">
                            <div class="chat-item__profile-picture me-3 d-flex justify-content-center align-items-center text-center" style="width: 40px; height: 40px;">
                                <svg xmlns="http://www.w3.org/2000/svg" style="margin-left: 10px; margin-top: 5px;" width="30" height="30" fill="currentColor"
                                    class="bi bi-person-fill" viewBox="0 0 16 16">
                                    <path
                                        d="M3 14s-1 0-1-1 1-4 6-4 6 3 6 4-1 1-1 1zm5-6a3 3 0 1 0 0-6 3 3 0 0 0 0 6" />
                                </svg>
                            </div>
                            <div class="chat-item__text">
                                <span class="chat-item__author"><b>${msg.user}</b></span>
                                <div class="chat-item__message">
                                    ${msg.content}
                                </div>
                            </div>
                        </div>
                    </li>
                    `;
                }
                else if (msg.user === "Moderator")
                {
                    messageTemplate = `
                    <li class="list-group-item d-flex justify-content-center">
                        <div class="chat-item chat-item--message d-flex align-items-center" style="max-width: 600px; width: 100%;">
                            <div class="chat-item__profile-picture me-3 d-flex justify-content-center align-items-center text-center" style="width: 40px; height: 40px;">
                                <svg xmlns="http://www.w3.org/2000/svg" style="margin-left: 10px; margin-top: 5px;" width="30" height="30" fill="currentColor"
                                    class="bi bi-person-fill" viewBox="0 0 16 16">
                                    <path
                                        d="M3 14s-1 0-1-1 1-4 6-4 6 3 6 4-1 1-1 1zm5-6a3 3 0 1 0 0-6 3 3 0 0 0 0 6" />
                                </svg>
                            </div>
                            <div class="chat-item__text">
                                <span class="chat-item__author"><b>${msg.user}</b></span>
                                <div class="chat-item__message">
                                    ${msg.content}
                                </div>
                            </div>
                        </div>
                    </li>
                    `;
                }
                else
                {
                    messageTemplate = 
                    `
                    <li class="list-group-item d-flex justify-content-center">
                        <div class="chat-item chat-item--message d-flex align-items-center" style="max-width: 600px; width: 100%;">
                            <div class="chat-item__profile-picture me-3 d-flex justify-content-center align-items-center text-center" style="width: 40px; height: 40px;">
                                <svg xmlns="http://www.w3.org/2000/svg" style="margin-left: 10px; margin-top: 5px;" width="30" height="30" fill="currentColor"
                                    class="bi bi-person-fill" viewBox="0 0 16 16">
                                    <path
                                        d="M3 14s-1 0-1-1 1-4 6-4 6 3 6 4-1 1-1 1zm5-6a3 3 0 1 0 0-6 3 3 0 0 0 0 6" />
                                </svg>
                            </div>
                            <div class="chat-item__text">
                                <span class="chat-item__author"><b>${msg.user}</b></span>
                                <div class="chat-item__message">
                                    ${msg.content}
                                </div>
                            </div>
                        </div>
                    </li>
                    `;
                }

                $('#app-holder').css('display', 'block');
                $('#spinner-holder').remove();

                $chatList.append(messageTemplate);
            });
        }

        function onChatHubConnected() {
            console.log("Connected to chat hub!");
            // Add any UI feedback here
        }

        $(() => {
            $.ajax({
                url: "/identity-information",
                method: "GET",
                success: function (data) {
                    user = data;
                    let userName = user.name;
                    connectToChatHub(userName);
                    console.log("User name:", userName);
                },
                error: function (xhr, status, error) {
                    console.error("Failed to get identity info:", error);
                }
            });
        });

        function sendMessageToHub(messageToSend) {
            if (!hubConnection || hubConnection.state !== signalR.HubConnectionState.Connected) {
                console.warn("Hub connection is not established.");
                return;
            }

            hubConnection.invoke("SendMessage", user.name, messageToSend)
                .then(() => {
                    onStateChanged();
                })
                .catch(function (err) {
                    console.error("Error sending message:", err.toString());
                });
        }

        $('#sendButton').on('click', function () {
            const $btn = $(this);
            const originalText = $btn.html();
            const message = $('#messageInput').val();

            if (!message.trim()) return;

            $btn.html(`<span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span> Sending...`);
            $btn.prop('disabled', true);

            sendMessageToHub(message);
            $('#messageInput').val('');
        });
    </script>

</body>
</html>